{
  "$type": "program",
  "forms": [
    ["def", "make-point",
      ["lambda", ["x", "y"],
        ["dict", "@x", "x", "@y", "y"]
      ]
    ],

    ["def", "point-distance",
      ["lambda", ["p1", "p2"],
        ["sqrt", ["+",
          ["pow", ["-", ["get", "p1", "@x"], ["get", "p2", "@x"]], 2],
          ["pow", ["-", ["get", "p1", "@y"], ["get", "p2", "@y"]], 2]
        ]]
      ]
    ],

    ["def", "compute-centroid",
      ["lambda", ["points"],
        ["if", ["empty?", "points"],
          ["make-point", 0, 0],
          ["do",
            ["def", "sum-x", ["reduce", "+", ["map", ["lambda", ["p"], ["get", "p", "@x"]], "points"], 0]],
            ["def", "sum-y", ["reduce", "+", ["map", ["lambda", ["p"], ["get", "p", "@y"]], "points"], 0]],
            ["def", "count", ["length", "points"]],
            ["make-point", ["/", "sum-x", "count"], ["/", "sum-y", "count"]]
          ]
        ]
      ]
    ],

    ["def", "nearest-centroid",
      ["lambda", ["point", "centroids"],
        ["if", ["empty?", "centroids"],
          ["error", "@No centroids available"],
          ["do",
            ["def", "distances", 
              ["map", ["lambda", ["c"], ["point-distance", "point", "c"]], "centroids"]
            ],
            ["def", "min-dist", ["apply", "min", "distances"]],
            ["def", "min-index", ["index", "distances", "min-dist"]],
            ["nth", "centroids", "min-index"]
          ]
        ]
      ]
    ],

    ["def", "assign-points-to-clusters",
      ["lambda", ["points", "centroids"],
        ["map", 
          ["lambda", ["point"],
            ["dict", 
              "@point", "point",
              "@cluster", ["nearest-centroid", "point", "centroids"]
            ]
          ],
          "points"
        ]
      ]
    ],

    ["def", "group-by-cluster",
      ["lambda", ["assignments"],
        ["reduce",
          ["lambda", ["acc", "assignment"],
            ["do",
              ["def", "cluster", ["get", "assignment", "@cluster"]],
              ["def", "point", ["get", "assignment", "@point"]],
              ["def", "cluster-key", ["str-concat", 
                ["to-string", ["get", "cluster", "@x"]], 
                "@,", 
                ["to-string", ["get", "cluster", "@y"]]
              ]],
              ["def", "existing", ["get", "acc", "cluster-key", ["list"]]],
              ["set", "acc", "cluster-key", ["append", "existing", "point"]]
            ]
          ],
          "assignments",
          ["dict"]
        ]
      ]
    ],

    ["def", "k-means-step",
      ["lambda", ["points", "centroids"],
        ["do",
          ["def", "assignments", ["assign-points-to-clusters", "points", "centroids"]],
          ["def", "grouped", ["group-by-cluster", "assignments"]],
          ["map",
            ["lambda", ["cluster-points"], ["compute-centroid", "cluster-points"]],
            ["values", "grouped"]
          ]
        ]
      ]
    ],

    ["def", "centroids-converged?",
      ["lambda", ["old-centroids", "new-centroids", "threshold"],
        ["if", ["=", ["length", "old-centroids"], ["length", "new-centroids"]],
          ["do",
            ["def", "distances",
              ["map", 
                ["lambda", ["i"], 
                  ["point-distance", 
                    ["nth", "old-centroids", "i"], 
                    ["nth", "new-centroids", "i"]
                  ]
                ],
                ["map", ["lambda", ["i"], "i"], ["list", 0, 1, 2]]
              ]
            ],
            ["<", ["apply", "max", "distances"], "threshold"]
          ],
          false
        ]
      ]
    ],

    ["def", "create-k-means-clusterer",
      ["lambda", ["verbose?"],
        ["lambda", ["points", "k", "max-iterations", "threshold"],
          ["do",
            ["def", "initial-centroids", ["slice", "points", 0, "k"]],
            ["def", "log", 
              ["if", "verbose?", 
                ["lambda", ["msg"], ["print", "msg"]], 
                ["lambda", ["msg"], "msg"]
              ]
            ],
            ["def", "iterate",
              ["lambda", ["centroids", "iteration"],
                ["if", [">", "iteration", "max-iterations"],
                  ["do",
                    ["log", "@Maximum iterations reached"],
                    "centroids"
                  ],
                  ["do",
                    ["def", "new-centroids", ["k-means-step", "points", "centroids"]],
                    ["log", ["str-concat", "@Iteration ", ["to-string", "iteration"], "@: ", ["to-string", ["length", "new-centroids"]], "@ clusters"]],
                    ["if", ["centroids-converged?", "centroids", "new-centroids", "threshold"],
                      ["do",
                        ["log", "@Converged!"],
                        ["dict",
                          "@centroids", "new-centroids",
                          "@iterations", "iteration",
                          "@converged", true,
                          "@final-assignments", ["assign-points-to-clusters", "points", "new-centroids"]
                        ]
                      ],
                      ["iterate", "new-centroids", ["+", "iteration", 1]]
                    ]
                  ]
                ]
              ]
            ],
            ["iterate", "initial-centroids", 1]
          ]
        ]
      ]
    ],

    ["def", "create-data-analyzer",
      ["lambda", ["dataset"],
        ["lambda", ["analysis-type"],
          ["if", ["=", "analysis-type", "@k-means"],
            ["do",
              ["def", "clusterer", ["create-k-means-clusterer", true]],
              ["lambda", ["k", "max-iter", "threshold"],
                ["clusterer", "dataset", "k", "max-iter", "threshold"]
              ]
            ],
            ["if", ["=", "analysis-type", "@summary"],
              ["lambda", [],
                ["dict",
                  "@count", ["length", "dataset"],
                  "@x-coords", ["map", ["lambda", ["p"], ["get", "p", "@x"]], "dataset"],
                  "@y-coords", ["map", ["lambda", ["p"], ["get", "p", "@y"]], "dataset"]
                ]
              ],
              ["error", ["str-concat", "@Unknown analysis type: ", "analysis-type"]]
            ]
          ]
        ]
      ]
    ]
  ],
  "entrypoint": [
    "do",
    ["def", "sample-points", [
      "list",
      ["make-point", 1.0, 1.0],
      ["make-point", 1.5, 2.0],
      ["make-point", 3.0, 4.0],
      ["make-point", 5.0, 7.0],
      ["make-point", 3.5, 5.0],
      ["make-point", 4.5, 5.0],
      ["make-point", 3.5, 4.5],
      ["make-point", 2.0, 2.0],
      ["make-point", 2.0, 1.0],
      ["make-point", 1.0, 3.0]
    ]],
    
    ["print", "@Creating data analyzer..."],
    ["def", "data-analyzer", ["create-data-analyzer", "sample-points"]],
    
    ["print", "@Getting dataset summary..."],
    ["def", "summary-fn", ["data-analyzer", "@summary"]],
    ["def", "summary", ["summary-fn"]],
    ["print", ["str-concat", "@Dataset has ", ["to-string", ["get", "summary", "@count"]], "@ points"]],
    
    ["print", "@Creating K-means clusterer..."],
    ["def", "kmeans-fn", ["data-analyzer", "@k-means"]],
    
    ["print", "@Running clustering analysis..."],
    ["def", "clustering-result", ["kmeans-fn", 3, 10, 0.1]],
    
    ["print", "@Analysis complete!"],
    ["print", ["str-concat", "@Converged in ", ["to-string", ["get", "clustering-result", "@iterations"]], "@ iterations"]],
    
    ["lambda", ["result-type"],
      ["if", ["=", "result-type", "@centroids"],
        ["get", "clustering-result", "@centroids"],
        ["if", ["=", "result-type", "@assignments"],
          ["get", "clustering-result", "@final-assignments"],
          ["if", ["=", "result-type", "@summary"],
            "summary",
            "clustering-result"
          ]
        ]
      ]
    ]
  ]
}